<div class="theme-toggle-container">
  <button
    class="theme-toggle-btn"
    onclick="toggleDropdown()"
    aria-label="Toggle theme"
    title="Change theme"
  >
    <span class="theme-icon" id="theme-icon">‚òÄÔ∏è</span>
  </button>

  <div class="theme-dropdown" id="theme-dropdown">
    <button
      class="theme-option"
      onclick="setThemeAndClose('light')"
      aria-label="Switch to light theme"
    >
      <span class="theme-icon">‚òÄÔ∏è</span> Light
    </button>
    <button
      class="theme-option"
      onclick="setThemeAndClose('dark')"
      aria-label="Switch to dark theme"
    >
      <span class="theme-icon">üåô</span> Dark
    </button>
    <button
      class="theme-option"
      onclick="setThemeAndClose('auto')"
      aria-label="Switch to auto theme"
    >
      <span class="theme-icon">üíª</span> Auto
    </button>
  </div>
</div>

<script>
  function getCurrentTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) return savedTheme;

    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    return prefersDark ? 'dark' : 'light';
  }

  function applyTheme(theme: any) {
    const html = document.documentElement;

    html.classList.remove('light', 'dark');

    if (theme === 'dark') {
      html.classList.add('dark');
      html.style.colorScheme = 'dark';
    } else if (theme === 'light') {
      html.classList.add('light');
      html.style.colorScheme = 'light';
    } else {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (prefersDark) {
        html.classList.add('dark');
        html.style.colorScheme = 'dark';
      } else {
        html.classList.add('light');
        html.style.colorScheme = 'light';
      }
    }

    const iconElement = document.getElementById('theme-icon');
    if (iconElement) {
      if (theme === 'dark') {
        iconElement.textContent = 'üåô';
      } else if (theme === 'auto') {
        iconElement.textContent = 'üíª';
      } else {
        iconElement.textContent = '‚òÄÔ∏è';
      }
    }
  }

  // Function to set the theme and close dropdown
  function setThemeAndClose(theme: any) {
    localStorage.setItem('theme', theme);
    applyTheme(theme);
    closeDropdown();
  }

  // Function to toggle the dropdown
  function toggleDropdown() {
    const dropdown = document.getElementById('theme-dropdown');
    if (dropdown) {   // <-- only toggle if dropdown exists
      dropdown.classList.toggle('show');
    }
  }

  function closeDropdown() {
    const dropdown = document.getElementById('theme-dropdown');
    if (dropdown) {
      dropdown.classList.remove('show');
    }
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(event) {
    const dropdownContainer = document.querySelector('.theme-toggle-container');
    const dropdown = document.getElementById('theme-dropdown');

    // Make sure dropdownContainer exists and event.target is a Node
    if (dropdownContainer && event.target instanceof Node && !dropdownContainer.contains(event.target)) {
      closeDropdown();
    }
  });


  // Initialize theme on page load
  document.addEventListener('DOMContentLoaded', function() {
    const initialTheme = getCurrentTheme();
    applyTheme(initialTheme);

    // Listen for system theme changes when in auto mode
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
      if (localStorage.getItem('theme') === 'auto') {
        applyTheme('auto');
      }
    });
  });

  // Make functions available globally
  (window as any).setThemeAndClose = setThemeAndClose;
  (window as any).toggleDropdown = toggleDropdown;
  (window as any).closeDropdown = closeDropdown;

</script>

<style>
  .theme-toggle-container {
    position: relative;
    display: inline-block;
  }

  .theme-toggle-btn {
    background: var(--sl-color-gray-3);
    border: 1px solid var(--sl-color-gray-4);
    border-radius: 9999px;
    padding: 0.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-size: 1.2rem;
  }

  .theme-toggle-btn:hover {
    background: var(--sl-color-gray-4);
    transform: scale(1.05);
  }

  .theme-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    background: var(--sl-color-gray-2);
    border: 1px solid var(--sl-color-gray-4);
    border-radius: 0.5rem;
    padding: 0.5rem;
    min-width: 120px;
    box-shadow: 0 4px 6px var(--sl-color-gray-5);
    z-index: 100;
    flex-direction: column;
    gap: 0.25rem;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    max-height: 0;
    overflow: hidden;
  }

  .theme-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    max-height: 200px;
  }

  .theme-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border: none;
    background: transparent;
    cursor: pointer;
    border-radius: 0.25rem;
    text-align: left;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .theme-option:hover {
    background: var(--sl-color-gray-3);
    transform: translateX(5px);
  }

  .theme-option.active {
    background: var(--sl-color-accent-low);
    color: var(--sl-color-accent-high);
  }

  .theme-icon {
    font-size: 1rem;
  }
</style>